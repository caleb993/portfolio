<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin • Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body{background:#0b1220;color:#e6eef8;padding:18px}
      .card{border:0;border-radius:12px;background:#0f1724;padding:12px}
      .small-muted{ color:#9aa1b0 }
    </style>
    </head><body>
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div><h1 class="mb-0">Admin Panel</h1><div class="text-muted">Manage messages, uploads & media</div></div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-secondary" href="{{ url_for('export_messages') }}">Export CSV</a>
          <a class="btn btn-outline-secondary" href="{{ url_for('logout') }}">Logout</a>
        </div>
      </div>

      {% with msgs_flash = get_flashed_messages() %}
        {% if msgs_flash %}
          <div class="mb-3">
            {% for fm in msgs_flash %}<div class="alert alert-info">{{ fm }}</div>{% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5>Messages ({{ total_filtered }})</h5>
              <form class="d-flex" method="get" style="gap:8px;">
                <input name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="Search messages..." aria-label="Search messages">
                <select name="show" class="form-select form-select-sm" aria-label="Filter messages">
                  <option value="all" {% if show=='all' %}selected{% endif %}>All</option>
                  <option value="unread" {% if show=='unread' %}selected{% endif %}>Unread</option>
                </select>
                <input type="hidden" name="page" value="1">
                <button class="btn btn-primary btn-sm">Search</button>
              </form>
            </div>

            {% if display_msgs %}
              <div class="table-responsive">
                <table class="table table-sm table-striped" style="color:inherit;">
                  <thead><tr><th>#</th><th>When</th><th>Name</th><th>Email</th><th>Snippet</th><th>Actions</th></tr></thead>
                  <tbody>
                    {% for m in display_msgs %}
                      <tr>
                        <td>{{ loop.index + (page-1)*per_page }}</td>
                        <td>{{ m.timestamp }}</td>
                        <td>{{ m.name }} {% if m.status=='unread' %}<span style="color:#fff;background:#d63384;padding:2px 6px;border-radius:8px;font-size:.8rem;">unread</span>{% endif %}</td>
                        <td><a style="color:inherit" href="mailto:{{ m.email }}">{{ m.email }}</a></td>
                        <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;">{{ m.message[:120] }}{% if m.message|length>120 %}...{% endif %}</td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary" onclick="openMessageModal({{ m.gid }})">View</button>
                          <form method="post" action="{{ url_for('delete_message', mid=m.gid) }}" style="display:inline">
                            <button class="btn btn-sm btn-danger" onclick="return confirm('Delete?')">Delete</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <nav class="mt-2"><ul class="pagination pagination-sm">
                <li class="page-item {% if page<=1 %}disabled{% endif %}"><a class="page-link" href="{{ url_for('admin') }}?q={{ q|urlencode }}&show={{ show }}&page={{ page-1 }}&per_page={{ per_page }}">Previous</a></li>
                {% for p in range(1, pages+1) %}<li class="page-item {% if p==page %}active{% endif %}"><a class="page-link" href="{{ url_for('admin') }}?q={{ q|urlencode }}&show={{ show }}&page={{ p }}&per_page={{ per_page }}">{{ p }}</a></li>{% endfor %}
                <li class="page-item {% if page>=pages %}disabled{% endif %}"><a class="page-link" href="{{ url_for('admin') }}?q={{ q|urlencode }}&show={{ show }}&page={{ page+1 }}&per_page={{ per_page }}">Next</a></li>
              </ul></nav>
            {% else %}
              <p class="text-muted">No messages match your criteria.</p>
            {% endif %}
          </div>

          <!-- Analytics chart (Chart.js) -->
          <div class="card mt-3">
            <h5>Analytics (Messages last 30 days)</h5>
            <canvas id="messagesChart" width="400" height="120" aria-label="Messages chart"></canvas>
            <small class="text-muted d-block mt-2">This chart shows number of messages per day (last 30 days).</small>
          </div>

        </div>

        <div class="col-lg-5">
          <div class="card">
            <h5>Visitor Uploads (Pending) <small>({{ pending|length }})</small></h5>
            {% if pending %}
              <ul class="list-group mb-2">
                {% for f in pending %}
                  <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#0f1724;color:inherit;border:1px solid #1d2b4a;">
                    <span style="max-width:60%;overflow:hidden;text-overflow:ellipsis;">{{ f }}</span>
                    <span class="d-flex gap-2">
                      <form method="post" action="{{ url_for('approve_file', filename=f) }}"><button class="btn btn-sm btn-success">Approve</button></form>
                      <form method="post" action="{{ url_for('reject_file', filename=f) }}"><button class="btn btn-sm btn-danger">Reject</button></form>
                    </span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No pending uploads.</p>
            {% endif %}

            <hr>
            <h5>Approved Files</h5>
            {% if projects %}
              <ul class="list-group mb-2">
                {% for f in projects %}
                  <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#0f1724;color:inherit;border:1px solid #1d2b4a;">
                    <span style="max-width:60%;overflow:hidden;text-overflow:ellipsis;">{{ f }}</span>
                    <span>
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('download_file', kind='project', filename=f) }}">Download</a>
                      <form method="post" action="{{ url_for('delete_project', filename=f) }}" style="display:inline"><button class="btn btn-sm btn-danger">Delete</button></form>
                    </span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted">No approved files yet.</p>
            {% endif %}

            <hr>
            <h5>Owner CV</h5>
            {% if cv_file %}
              <p>Latest CV: <strong>{{ cv_file }}</strong></p>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_file', kind='cv', filename=cv_file) }}">Download CV</a>
            {% else %}
              <p class="text-muted">No CV uploaded yet.</p>
            {% endif %}
            <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_cv_admin') }}" class="mt-2">
              <input type="file" name="cv" class="form-control form-control-sm mb-2" required>
              <button class="btn btn-warning btn-sm">Upload / Replace CV</button>
            </form>
          </div>

          <div class="card mt-3">
            <h5>Site Media</h5>
            <div class="mb-2">
              <div class="small-muted">Profile</div>
              {% if prof %}<img src="{{ url_for('media_file', kind='profile', filename=prof) }}" style="width:64px;height:64px;border-radius:8px;">{% else %}<div class="text-muted">None</div>{% endif %}
              <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_profile_image') }}" class="mt-2">
                <input type="file" name="image" accept="image/*" class="form-control form-control-sm mb-2" required>
                <button class="btn btn-outline-primary btn-sm">Upload</button>
              </form>
            </div>
            <div class="mb-2">
              <div class="small-muted">Hero Background</div>
              {% if hero %}<img src="{{ url_for('media_file', kind='hero', filename=hero) }}" style="width:100%;height:80px;object-fit:cover;border-radius:8px;">{% else %}<div class="text-muted">None</div>{% endif %}
              <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_hero_image') }}" class="mt-2">
                <input type="file" name="image" accept="image/*" class="form-control form-control-sm mb-2" required>
                <button class="btn btn-outline-primary btn-sm">Upload</button>
              </form>
            </div>

            <hr>
            <h6>Gallery</h6>
            <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_gallery') }}">
              <input type="file" name="images" accept="image/*,video/*" multiple class="form-control form-control-sm mb-2" required>
              <button class="btn btn-primary btn-sm">Upload Image(s) / Video(s)</button>
            </form>
            {% if gal %}
              <ul class="list-group mt-2">
                {% for g in gal %}
                  <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#0f1724;color:inherit;">
                    <div style="display:flex;align-items:center;gap:8px;">
                      {% if g.type == 'image' %}
                        <img src="{{ g.url }}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
                      {% elif g.type == 'video' %}
                        <video muted playsinline preload="metadata" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
                          <source src="{{ g.url }}">
                        </video>
                      {% else %}
                        <img src="{{ g.url }}" style="width:56px;height:56px;object-fit:cover;border-radius:8px;">
                      {% endif %}
                      <span style="max-width:220px;overflow:hidden;text-overflow:ellipsis;">{{ g.name }}</span>
                    </div>
                    <form method="post" action="{{ url_for('delete_gallery_image', filename=g.name) }}"><button class="btn btn-sm btn-danger">Delete</button></form>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mt-2">No gallery media yet.</p>
            {% endif %}
          </div>

        </div>
      </div>

      <hr>
      <h5>Blog Posts</h5>
      <div class="card">
        <form method="post" action="{{ url_for('admin_add_blog') }}">
          <input name="title" class="form-control mb-2" placeholder="Post title" required>
          <textarea name="content" class="form-control mb-2" rows="4" placeholder="Write post content (plain text)..." required></textarea>
          <button class="btn btn-primary btn-sm">Publish</button>
        </form>

        <hr>
        {% if blogs %}
          <ul class="list-group">
            {% for b in blogs %}
              <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#0f1724;color:inherit;">
                <div>
                  <strong>{{ b.title }}</strong><div class="text-muted">{{ b.timestamp }}</div>
                </div>
                <div>
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('view_blog', slug=b.slug) }}" target="_blank">View</a>
                  <form method="post" action="{{ url_for('admin_delete_blog', bid=b.id) }}" style="display:inline"><button class="btn btn-sm btn-danger">Delete</button></form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No blog posts yet.</p>
        {% endif %}
      </div>

      <hr>
      <h5>Subscribers ({{ subscribers|length }})</h5>
      <div class="card">
        {% if subscribers %}
          <ul class="list-group">
            {% for s in subscribers %}
              <li class="list-group-item d-flex justify-content-between align-items-center" style="background:#0f1724;color:inherit;">
                <div>{{ s.get('email') }} <div class="text-muted small">{{ s.get('timestamp') }}</div></div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No subscribers yet.</p>
        {% endif %}
      </div>

    </div>

    <!-- Message modal -->
    <div class="modal fade" id="msgModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background:#0b1220;border:1px solid #1d2b4a;">
          <div class="modal-header"><h5 class="modal-title">Message details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div><strong>From:</strong> <span id="modal-name"></span></div>
            <div class="mb-2"><strong>Email:</strong> <a id="modal-email" href=""></a></div>
            <div class="mb-2"><strong>When:</strong> <span id="modal-when"></span></div>
            <hr>
            <div id="modal-message" style="white-space:pre-wrap;"></div>
          </div>
          <div class="modal-footer">
            <button id="modal-toggle-read" class="btn btn-outline-primary">Mark read</button>
            <form id="modal-delete-form" method="post" action=""><button class="btn btn-danger" onclick="return confirm('Delete this message?')">Delete</button></form>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      // openMessageModal uses credentials and improved error handling
      function openMessageModal(gid){
        try {
          const base = '{{ url_for("message_json", mid=0) }}';
          const url = base.replace('/0', '/' + encodeURIComponent(gid));
          fetch(url, { credentials: 'same-origin' })
            .then(r => {
              if (!r.ok) {
                console.error('Failed to fetch message JSON, status:', r.status, r.statusText);
                throw new Error('Status ' + r.status);
              }
              return r.json();
            })
            .then(data => {
              document.getElementById('modal-name').innerText = data.name || '(no name)';
              const emailEl = document.getElementById('modal-email');
              emailEl.innerText = data.email || '(no email)'; emailEl.href = 'mailto:' + (data.email || '');
              document.getElementById('modal-when').innerText = data.timestamp || '';
              document.getElementById('modal-message').innerText = data.message || '';
              const form = document.getElementById('modal-delete-form'); form.action = '/admin/delete_message/' + encodeURIComponent(gid);
              const toggleBtn = document.getElementById('modal-toggle-read');
              // handler
              toggleBtn.onclick = function(){
                fetch('/admin/toggle_read_json/' + encodeURIComponent(gid), { method: 'POST', credentials: 'same-origin' })
                  .then(r => {
                    if (!r.ok) {
                      console.error('Toggle read failed, status:', r.status);
                      throw new Error('Toggle status ' + r.status);
                    }
                    return r.json();
                  })
                  .then(res => {
                    if (res.status) {
                      toggleBtn.innerText = res.status === 'read' ? 'Mark unread' : 'Mark read';
                    }
                  }).catch(e => {
                    alert('Could not toggle read/unread. See console for details.');
                    console.error(e);
                  });
              };
              toggleBtn.innerText = data.status === 'unread' ? 'Mark read' : 'Mark unread';
              const modal = new bootstrap.Modal(document.getElementById('msgModal')); modal.show();
            })
            .catch(e => {
              alert('Could not load message — check console for details.');
              console.error('openMessageModal error:', e);
            });
        } catch (err) {
          alert('An unexpected error occurred while opening the message.');
          console.error(err);
        }
      }

      // Chart: fetch analytics data endpoint and render
      async function loadMessagesChart() {
        try {
          const resp = await fetch('{{ url_for("admin_analytics_data") }}', { credentials: 'same-origin' });
          if(!resp.ok) throw new Error('Fetch analytics failed: ' + resp.status);
          const data = await resp.json();
          const ctx = document.getElementById('messagesChart').getContext('2d');
          const chart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Messages',
                data: data.values,
                borderRadius: 6,
                barPercentage: 0.8,
                categoryPercentage: 0.8
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: { mode: 'index', intersect: false }
              },
              scales: {
                x: { ticks: { color: '#cbd5e1' } },
                y: { ticks: { color: '#cbd5e1' }, beginAtZero: true }
              }
            }
          });
        } catch (e) {
          console.error('loadMessagesChart error:', e);
        }
      }
      loadMessagesChart();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </body></html>
